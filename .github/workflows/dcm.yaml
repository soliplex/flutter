# =============================================================================
# DCM Metrics - Stage 2: Non-Blocking
# =============================================================================
# Separate workflow for DCM static analysis.
# Reports findings but does NOT block PRs during rollout.
#
# Requires secrets: DCM_CI_KEY, DCM_EMAIL, DCM_PROJECT_KEY
# =============================================================================

name: DCM Metrics

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Stage 2: Don't block PRs - remove this line for Stage 5
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install DCM
        run: |
          sudo apt-get update
          wget -qO- https://dcm.dev/pgp-key.public | sudo gpg --dearmor -o /usr/share/keyrings/dcm.gpg
          echo 'deb [signed-by=/usr/share/keyrings/dcm.gpg arch=amd64] https://dcm.dev/debian stable main' | sudo tee /etc/apt/sources.list.d/dcm.list
          sudo apt-get update
          sudo apt-get install dcm

      - name: Run DCM Analyze
        run: |
          dcm analyze lib \
            --ci-key="${{ secrets.DCM_CI_KEY }}" \
            --email="${{ secrets.DCM_EMAIL }}"

      - name: Upload metrics to DCM Dashboard
        run: |
          dcm run lib --all --upload \
            --ci-key="${{ secrets.DCM_CI_KEY }}" \
            --email="${{ secrets.DCM_EMAIL }}" \
            --project="${{ secrets.DCM_PROJECT_KEY }}"
